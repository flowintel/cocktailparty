<.header>
  Source <%= @source.name %>
  <:subtitle>This is a source record from your database.</:subtitle>
  <:actions>
    <.link :if={@is_admin} href={~p"/admin/sources/#{@source}/edit"}>
      <.button>Edit source</.button>
    </.link>
    <.link
      :if={!@is_admin && !@source.subscribed}
      href={~p"/sources/subscribe/#{@source}"}
      method="post"
    >
      <.button>Subscribe</.button>
    </.link>
    <.link
      :if={!@is_admin && @source.subscribed}
      href={~p"/sources/unsubscribe/#{@source}"}
      method="delete"
    >
      <.button>Unsubscribe</.button>
    </.link>
  </:actions>
</.header>

<.modal :if={@is_admin} id="subscriber">
  <.simple_form
    :let={f}
    for={@changeset}
    phx-change="validate"
    phx-submit="save"
    method="post"
    action={~p"/admin/sources/subscribe/#{@source}"}
  >
    <.error :if={@changeset.action}>
      Oops, something went wrong! Please check the errors below.
    </.error>
    <.input
      field={f[:user_id]}
      type="select"
      label="User"
      options={Enum.map(@potential_subscribers, fn user -> {user.email, user.id} end)}
    />
    <:actions>
      <.button>Subscribe user</.button>
      <.link
        href={~p"/admin/sources/mass_subscribe/#{@source}"}
        method="post"
        data-confirm="Are you sure?"
      >
        <.button>Subscribe all users</.button>
      </.link>
    </:actions>
  </.simple_form>
</.modal>

<.list>
  <:item title="Name"><%= @source.name %></:item>
  <:item title="Id"><%= @source.id %></:item>
  <:item title="Description"><%= @source.description %></:item>
  <:item title="Type"><%= @source.type %></:item>
  <:item title="Channel"><%= @source.channel %></:item>
  <:item :if={@is_admin} title="Redis instance"><%= @source.redis_instance.name %></:item>

  <:item title="Public">
    <.icon :if={@source.public} name="hero-check" />
    <.icon :if={!@source.public} name="hero-x-mark" />
  </:item>
</.list>

<br />
<div :if={@is_admin}>
  <.header>
    Subscribers
    <:subtitle>Users that can receive message from this source</:subtitle>
    <:actions>
      <.link phx-click={show_modal("subscriber")}>
        <.button>Add subscribers</.button>
      </.link>
      <.link
        href={~p"/admin/sources/mass_unsubscribe/#{@source}"}
        method="delete"
        data-confirm="Are you sure?"
      >
        <.button>Unsubscribe all</.button>
      </.link>
    </:actions>
  </.header>

  <.table id="users" rows={@source.users} row_click={&JS.navigate(~p"/admin/users/#{&1}")}>
    <:col :let={user} label="email">
      <div class="indicator">
        <span :if={user.is_present} class="indicator-item badge badge-success"></span>
        <span :if={!user.is_present} class="indicator-item badge badge-ghost"></span>
        <span><%= user.email %></span>
      </div>
    </:col>

    <:action :let={user}>
      <.link
        href={~p"/admin/sources/unsubscribe/#{@source}/#{user}"}
        method="delete"
        data-confirm="Are you sure?"
      >
        Unsubscribe
      </.link>
    </:action>
  </.table>
</div>

<br />
<h1 class="text-lg font-semibold leading-8 text-zinc-800">Instructions</h1>
<div class="w-full border-opacity-50">
  In order to collect the data from the websocket one need to join the feed channel using the following parameters:
  <div class="overflow-y-auto px-4 sm:overflow-visible sm:px-0">
    <table class="mt-11 w-[40rem] sm:w-full">
      <thead class="text-left text-[0.8125rem] leading-6 text-zinc-500"></thead>
      <tbody class="relative divide-y divide-zinc-100 border-t border-zinc-200 text-sm leading-6 text-zinc-700">
        <tr class="group hover:bg-zinc-50">
          <td class="relative p-0 hover:cursor-pointer">
            <div class="block py-4 pr-6">
              <span class="relative font-semibold text-zinc-900">
                protocol
              </span>
            </div>
          </td>
          <td class="relative p-0 w-14">
            <div class="relative whitespace-nowrap py-4 text-right text-sm font-medium">
              wss://
            </div>
          </td>
        </tr>

        <tr class="group hover:bg-zinc-50">
          <td class="relative p-0 hover:cursor-pointer">
            <div class="block py-4 pr-6">
              <span class="relative font-semibold text-zinc-900">
                host
              </span>
            </div>
          </td>
          <td class="relative p-0 w-14">
            <div class="relative whitespace-nowrap py-4 text-right text-sm font-medium">
              <%= @conn.host %>
            </div>
          </td>
        </tr>

        <tr class="group hover:bg-zinc-50">
          <td class="relative p-0 hover:cursor-pointer">
            <div class="block py-4 pr-6">
              <span class="relative font-semibold text-zinc-900">
                port
              </span>
            </div>
          </td>
          <td class="relative p-0 w-14">
            <div class="relative whitespace-nowrap py-4 text-right text-sm font-medium">
              <%!-- <%= Integer.to_string(@conn.port) %> --%> 443
            </div>
          </td>
        </tr>

        <tr class="group hover:bg-zinc-50">
          <td class="relative p-0 hover:cursor-pointer">
            <div class="block py-4 pr-6">
              <span class="relative font-semibold text-zinc-900">
                ressource
              </span>
            </div>
          </td>
          <td class="relative p-0 w-14">
            <div class="relative whitespace-nowrap py-4 text-right text-sm font-medium">
              /feedsocket/websocket?vsn=2.0.0&token=
            </div>
          </td>
        </tr>

        <tr class="group hover:bg-zinc-50">
          <td class="relative p-0 hover:cursor-pointer">
            <div class="block py-4 pr-6">
              <span class="relative font-semibold text-zinc-900">
                token
              </span>
            </div>
          </td>
          <td class="relative p-0 w-14">
            <div class="relative whitespace-nowrap py-4 text-right text-sm font-medium">
              <%= @user_token %>
            </div>
          </td>
        </tr>

        <tr class="group hover:bg-zinc-50">
          <td class="relative p-0 hover:cursor-pointer">
            <div class="block py-4 pr-6">
              <span class="relative font-semibold text-zinc-900">
                join message
              </span>
            </div>
          </td>
          <td class="relative p-0 w-14">
            <div class="relative whitespace-nowrap py-4 text-right text-sm font-medium">
              ["0","0","feed:<%= @source.id %>","phx_join",{}]
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <br />
  For instance, using a tool like <a href="https://github.com/vi/websocat" class="link">websocat</a>, simply download the latest release for your platform and start receiving data with the following command:<br />
  <div class="grid h-80 place-items-center">
    <div class="mockup-code">
      <pre><code>./websocat.x86_64-unknown-linux-musl \
    --ping-interval 5 \
    "wss://<%= @conn.host %>:443/feedsocket/websocket?token=<%= @user_token %>&vsn=2.0.0" \
    -p '["0","0","feed:<%= @source.id %>","phx_join",{}]'
  </code></pre>
    </div>
  </div>

  <.table id="sample" rows={@sample} overflow="overflow-auto">
    <:col :let={event} label="Latest 5 messages"><%= event %></:col>
  </.table>
</div>

<.back :if={!@is_admin} navigate={~p"/sources"}>Back to sources</.back>
<.back :if={@is_admin} navigate={~p"/admin/sources"}>Back to sources</.back>
<.modal
  id="subscribe"
  on_confirm={JS.push("delete")}
  on_cancel={JS.navigate(~p"/admin/sources/#{@source}")}
>
  html content
  <:confirm>Add user</:confirm>
  <:cancel>Cancel</:cancel>
</.modal>
